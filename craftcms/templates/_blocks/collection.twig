{# redeclare the variables set in `templates/_blocks/_base.twig` that we'll be using here #}
{% set settings = settings ??? null %}
{% set content  = content  ??? null %}
{% set grid     = grid     ??? settings.grid          ??? null %}
{% set text     = text     ??? content.text           ??? null %}

{% set entries  = entries  ??? content.entries.all()  ??? null %}
{% set searches = searches ??? content.searches.all() ??? null %}
{% set assets   = assets   ??? content.assets.all()   ??? null %}
{% set custom   = custom   ??? content.items.all()    ??? null %}

{% set component = component ??? settings.itemComponent ??? null %}
{% set itemCard  = itemCard  ??? settings.itemCard      ??? null %}

{% set collectionType  = content.collectionType ??? null %}

{% set collectionItems = collectionType == 'items'   ? custom  : null %}
{% set collectionItems = collectionType == 'entries' ? entries : collectionItems %}
{% set collectionItems = collectionType == 'assets'  ? assets  : collectionItems %}

{% if collectionType == 'search' %}

    {% set search      = searches|first %}
    {% set contentType = search.contentType.reference() ??? null %}
    {% set section     = contentType.section     ??? null %}
    {% set entryType   = contentType.entryType   ??? null %}
    {% set limit       = content.limit           ??? -1 %}
    {% set sort        = search.sort.value       ??? null %}
    {% set topics      = search.taxonomies.all() ??? null %}

    {# search/sort/filter settings #}
    {% set orderBy = 'postDate DESC' %}
    {% set orderBy = ( sort == 'random'       ) ? 'RAND()'        : orderBy %}
    {% set orderBy = ( sort == 'alphabetical' ) ? 'title DESC'    : orderBy %}
    {% set orderBy = ( sort == 'upcoming'     ) ? 'startDate ASC' : orderBy %}

    {# being to create the starting query #}
    {% set collectionQuery = craft.entries()
        .orderBy(orderBy)
        .limit(limit) %}

    {% set collectionQuery = section   ? collectionQuery.section(section)  : collectionQuery %}
    {% set collectionQuery = entryType ? collectionQuery.type(entryType)   : collectionQuery %}
    {% set collectionQuery = topics    ? collectionQuery.relatedTo(topics) : collectionQuery %}

    {% set collectionItems = collectionQuery.all() ??? null %}

{% endif %}

{# -- prepare the collection items content for cell2 --- #}
{% set collection %}

    {#-- let the component sort out how to display all the items --#}
    {% if component %}

        {{- include( component, {
            items: collectionItems,
            settings: settings
        }, withContext = false ) -}}

    {#-- otherwise hand off to a treatment --#}
    {% else %}
        {% for item in collectionItems %}

            {# {{ include( collectionCard ??? '_components/cards/basic', { #}
            {{ include( '_components/cards/basic', {
                entry : item,
                settings: settings
            }, withContext = false ) }}

        {% endfor %}
    {% endif %}
{% endset %}


{% if grid %}
    {% embed grid %}
        {% block cell1 %}
            {{text|raw}}
        {% endblock %}

        {% block cell2 %}
            {{collection|raw}}
        {% endblock %}
    {% endembed %}
{% endif %}