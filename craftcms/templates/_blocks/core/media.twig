{## Media Block Base
 ------------------------------------------------------------------------------------ ##
    -> http://localhost:8000/sitehub/blocks/media
 ------------------------------------------------------------------------------------ ##}
{% extends "_blocks/core/block" %}


{## Render the block using a two-zone micro-layout
 ------------------------------------------------------------------------------------ ##
    -> http://localhost:8000/sitehub/layout/micro-layouts
    -> http://buildwithburton.com/docs/micro-layouts
 ------------------------------------------------------------------------------------ ##}
{% block content %}

    {% from "_layout/core/micro" import layout as renderMicroLayout %}
    {# renderMicroLayout( layoutName, [ zone1, zone2, header, footer ], { arg1: x, .. } )
     -------------------------------------------------------------------------------- ##}
    {{ renderMicroLayout(
        block.settings.microLayout|default(),

        [ block('content_text'), block('content_media'),
          block('block_header'), block('block_footer') ],

        { container : block.settings.container|default() }
    ) }}

{% endblock content %}


{## Default handler for rendering media assets
 ------------------------------------------------------------------------------------ ##
    This block can be overridden in a child template
 ------------------------------------------------------------------------------------ ##}
{% block content_media %}

    {% set sourceItems = 'local' == block.source.value ??? block.source ??? null
        ? block.assets.all() ??? block.assets ??? null : block.embeds.all() ??? block.embeds ??? null %}

    {% set items = [] %}
    {% for item in sourceItems %}

        {## if there's a sourceUrl, we're embedding an external resource, lets use
            oEmbed to get the title, summary, and images from the source.
         ---------------------------------------------------------------------------- ##}
        {% set embedInfo = item.sourceUrl|default() ? embedInfo( item.sourceUrl ) : null %}

        {% set items = items|merge([{
            headline : item.alt           ??? item.title  ??? embedInfo.title  ??? null,
            summary  : item.summary       ??? item.dek    ??? item.text        ??? embedInfo.summary ??? null,
            image    : item.images.all()  ??? item.images ??? embedInfo.images ??? null,
            sourceUrl: item.sourceUrl     ??? null,
            source   : block.source.value ??? null,
            section  : 'media',
            embed    : embedInfo,
            entry    : item,
        }]) %}
    {% endfor %}

    {{ block( 'media_render_loop' ) }}
{% endblock %}



{## Render the Media items by passing them to a "loop" template.
 ------------------------------------------------------------------------------------ ##}
{% block media_render_loop %}
    {{ include( block.settings.mediaLoop ??? block.settings['mediaLoop.default'] ??? '_blocks/loop.auto', {
        items   : items|default(),
        settings: block.settings|default()
    }, withContext = false  ) }}
{% endblock %}