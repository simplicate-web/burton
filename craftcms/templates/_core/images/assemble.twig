
{% macro frame( image = null, frame = null, settings = null ) %}

    {## Attempt to Frame an Image ##}
    {% set framed = frame and image ? include( template_from_string(
        "{% from '_site/images/frames' import #{frame} as m %}{% if m is defined -%}{{m(i,s)}}{% endif %}"
    ), { i: image, s: settings } ) ??? null %}

    {% if framed -%}
        {{ framed }}
    {%- else -%}
        {{ _self.generate( image, {
            class        : settings.imageClass     ??? "w-full max-w-full h-auto",
            figure       : settings.imageFigure    ??? "w-full block",
            transform    : settings.imageTransform ??? null,
            _placeholder : settings._placeholder   ??? null
        } ) }}
    {%- endif -%}
{% endmacro %}


{## Render a single image tag ##}
{% macro generate( images = null, settings = null ) %}

    {## test to make sure images wasn't passed as an array ##}
    {% set image = null %}
    {% set image = images.url ??? null ? images : null %}
    {% set image = not image and images is iterable ? images.one() ??? images|first ??? null : image %}


    {## passed an image object ##}
    {% if image and image.url %}

        {% if settings.transform|default() and image.url|default() and image.id|default() %}
            {% do image.setTransform( settings.transform ) %}
        {% endif %}

        {{ tag( 'figure', {
            class:  "relative z-10 " ~ settings.figure ??? null,
            html: tag( 'img', {
                src    : image.url,
                width  : image.width    ??? null,
                height : image.height   ??? null,
                class  : settings.class ??? null,
                loading: 'lazy'
            })
        }) }}

    {% endif %}


    {## passed something like <img src='whatever'> ##}
    {% if not image and images and not images is iterable %}
        {{ tag( 'figure', {
            class:  settings.figure ??? null,
            html : images | retconAttr( 'img', { class: settings.class ??? null, loading: 'lazy' }, false )
        }) }}
    {% endif %}


    {## placeholder ##}
    {% if ( images is iterable and not image ) or not images %}
        {{ settings._placeholder ??? null == 'icon'
            ? _self.placeholder( 170, 170, 'icon' )
            : _self.placeholder()  }}
    {% endif %}

{% endmacro %}



{## automatic placeholder images during development & staging ##}
{% macro placeholder( transformNameOrWidth, height, type = null ) %}
    {% if getenv('CRAFT_ENVIRONMENT') != 'production' %}

        {% set width = 900 %}
        {% if height ??? null %}
            {% set width = transformNameOrWidth %}
        {% else %}
            {% set height = 500 %}
        {% endif %}

        {% if transformNameOrWidth ??? null != width %}
            {% set transform = craft.app.getImageTransforms().getTransformByHandle( transformNameOrWidth|default('videoAspect') ) %}
            {% set width  = transform.width|default(width)   %}
            {% set height = transform.height|default(height) %}
        {% endif %}

        {{ _self.generate( tag( 'img', {
            src: type == 'icon'
                ? "https://placeskull.com/#{width}/#{height}/475569/#{random(1,24)}"
                : "https://picsum.photos/seed/#{random(1,9999)}/#{width}/#{height}?grayscale&blur=2",
            alt: 'Placeholder'
        }) ) }}
    {% endif %}
{% endmacro %}