{## Matrix Block & Builder Macros
 ------------------------------------------------------------------------------------ ##
    This file mostly contains macros for assembling matrix blocks and builders.

    It *can* be inherited as a base block, but ideally only as a last resort fallback.

    A more robust block base should be created in `_site/base/block`, which all default
    blocks already look for in their inheritence chain before falling back to this file.
 ------------------------------------------------------------------------------------ ##}
{% extends template_from_string('{% block block %}{% endblock %}') %}
{% block block _self.brick( block ??? null ) %}
{% block block__text block.text ??? null %}
{## --------------------------------------------------------------------------------- ##}



{## Macro: blockOrBuilder
 ------------------------------------------------------------------------------------ ##
    Parameters:
    - content: The static content to be displayed if not empty.
    - builder: The builder to be used if 'content' is empty.
    - entry: The entry object, if provided.
    - settings: Additional settings for customization, such as container and spacer.

    Description:
    This macro is used to output a named twig {% block %} from the calling template
    with proper spacing around it. In the absence of html from a {% block %}, it
    will attempt to render the desired builder from the provided entry.

    Also allows for customization of additional block settings.

    Example Usage:
    {% set settings = { container: "fluid", spacer: "base" } %}
    {{ blockOrBuilder( block('content'), 'content', entry, settings ) }}

    In the above case, if {% block content %} is empty on the calling template, the
    macro will attempt to build the `bodyBuilder` matrix field on `entry`.
 ------------------------------------------------------------------------------------ ##}
{% macro blockOrBuilder( html = "", builder = "content", entry = null, settings = {} ) %}
    {% import "_core/assemble" as assemble %}

    {% if builder == 'content' %}
        {% set settings = { container: "fluid", spacer: "base" } | merge( settings ) %}
    {% endif %}

    {% if builder == 'header' %}
        {% set settings = { container: "fluid", spacer: false } | merge( settings ) %}
    {% endif %}

    {% if builder == 'sidebar' %}
        {% set settings = { container: "sidebar", spacer: "sm" } | merge( settings ) %}
    {% endif %}

    {% if html | trim %}
        {% set spacer = assemble.spacer( settings.spacer ) %}
        {{ assemble.container( settings.container, "#{spacer}#{html}#{spacer}" | raw ) }}
    {% else %}
        {% if builder == 'content' %}
            {{ _self.assembleBlocks( entry.bodyBuilder.all() ??? null, 'content', settings )}}
        {% endif %}

        {% if builder == 'header' %}
            {{ _self.assembleBlocks( entry.headerBuilder.all() ??? null, 'header', settings )}}
        {% endif %}

        {% if builder == 'sidebar' %}
            {{ _self.assembleBlocks( entry.sidebarBuilder.all() ??? null, 'sidebar', settings )}}
        {% endif %}
    {% endif %}
{% endmacro %}
{## --------------------------------------------------------------------------------- ##}




{## This macro is only used as part of the fallback template above and doesn't create
    properly inheritable and overloadable blocks ##}
{% macro brick( block ) %}
    {% import "_core/assemble" as assemble %}
    {{ assemble.spacer( block.settings.betweenBefore ??? false ) }}
    {{ _self.openTheme( block.settings, true ) }}
    {{ _self.openBlock( block.settings ) }}
    {{ _self.closeBlock( block.settings ) }}
    {{ _self.closeTheme( block.settings, true ) }}
    {{ assemble.spacer( block.settings.betweenAfter ??? false ) }}
{% endmacro %}
{## --------------------------------------------------------------------------------- ##}


{## Opens a theme wrapper inside a block (or anywhere else really) ##}
{## --------------------------------------------------------------------------------- ##}
{% macro openTheme( settings = {}, autoSpace = false ) -%}
    {% import "_core/assemble" as assemble %}

    {% set wrapper = {
        tag  : settings.tag   ?? settings.themeTag   ?? "div",
        class: settings.class ?? settings.themeClass ?? "theme relative"
    } %}

    {% set data = {
        theme   : settings.theme      ?? "base",
        block   : settings.blockType  ?? "unknown",
        uuid    : settings.uuid       ?? null,
        bodytext: true,
        viewport: true,
        next    : ( settings.themeNext ??? null )
                    ? { theme: settings.themeNext }
                    : settings.next ??? null,

        prev    : ( settings.themePrev ??? null )
                    ? { theme: settings.themePrev }
                    : settings.prev ??? null,
    } %}


    {## We only open the theme tag if it's different from the previous block ##}
    {%- if settings.prev.theme ??? null != data.theme -%}
        <{{wrapper.tag}} {{attr({
            class: wrapper.class,
            data : data
        })}}>
    {%- endif -%}

    {## BUT we need to add a spacer regardless as it creates a buffer between theme
        edge and its content, but also between consecutive blocks of the same theme.
     -------------------------------------------------------------------------------- ##}
    {{ assemble.spacer( settings.gapAbove ?? autoSpace ) }}
{% endmacro %}


{% macro closeTheme( settings = {}, autoSpace = false ) %}
    {% import "_core/assemble" as assemble %}

    {% set settings = {
        tag       : settings.tag ?? settings.themeTag ?? "div",
        theme     : settings.theme      ?? "base",
        themeNext : settings.themeNext  ?? null,
        spaceBelow: settings.spaceBelow ?? settings.gapBelow ?? autoSpace,
    } %}

    {## We only close the theme tag if it's different from the next block, and
        unlink openTheme(), we only add a spacer if we're closing the theme
     -------------------------------------------------------------------------------- ##}
    {%- if settings.themeNext != settings.theme -%}
        {{ assemble.spacer( settings.spaceBelow ) }}
        </{{settings.tag}}>
    {%- endif -%}
{% endmacro %}
{## --------------------------------------------------------------------------------- ##}



{## Block Related Macros ##}
{## --------------------------------------------------------------------------------- ##}
{% macro assembleBlocks( blocks = [], builder = 'content', defaultSettings = {} ) -%}

    {## created the option to store some default settings in a config file ##}
    {% set config = craft.app.config.getConfigFromFile('burton') ?? {} %}

    {% set minimalSettings = config.blockDefault   ?? { container: "none" } %}
    {% set blockTemplates  = config.blockTemplates ?? ["_core/block.%blockType%"] %}

    {% for block in normalizeBlocks( blocks, builder, minimalSettings | merge( defaultSettings ) ) %}
        {% set path = blockTemplates | map( p => p|replace({
            '%layout%'   : block.settings.layout    ??? null,
            '%section%'  : block.settings.section   ??? null,
            '%builder%'  : block.settings.builder   ??? null,
            '%blockType%': block.settings.blockType ??? null,
            '%entryType%': block.settings.entryType ??? null,
            '%variant%'  : block.settings.variant   ??? null,
        }) ) %}

        {{ include( path, { block: block }, withContext = false ) }}
    {% endfor %}
{% endmacro %}


{% macro openBlock( settings = {} ) -%}
    {% set settings = {
        tag     : settings.tag   ?? settings.blockTag   ?? "section",
        class   : settings.class ?? settings.blockClass ?? "w-full relative z-20",
        block   : settings.type  ?? settings.blockType  ?? '',
        uuid    : settings.uuid  ?? null,
        viewport: true,
    } %}

    <{{settings.tag}} {{attr({
        class: settings.class,
        data : settings | withoutKey(['class', 'tag'])
    })}}>
{%- endmacro %}

{% macro closeBlock( settings = {} ) -%}</{{settings.tag ??? settings.blockTag ??? "section"}}>{%- endmacro %}
{## --------------------------------------------------------------------------------- ##}



{## Reusable Content (Fragments & Bits) ##}
{## --------------------------------------------------------------------------------- ##}
{% macro fragment( query = null, builder = 'content', settings = {} ) %}
    {%- if query.id ??? query.slug ??? query.preset ??? null -%}
        {% set fragment = craft.entries({section:"reusable"}|merge( query )).one() ??? null %}
        {% if fragment %}
            {{ _self.blockOrBuilder( null, builder, fragment, settings ) }}
        {% endif %}
    {%- endif -%}
{% endmacro %}
{## --------------------------------------------------------------------------------- ##}