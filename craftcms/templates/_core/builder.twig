{## Builder Macros
 ------------------------------------------------------------------------------------ ##}
{% macro default( blocks, settings ) -%}
    {% set blocks   = blocks   is null ? [] : blocks   %}
    {% set settings = settings is null ? {} : settings %}
    {% set builder  = settings.builder ??? 'default' %}

    {% set hasentry = null %}
    {% for b in blocks %}
        {% set hasentry = b['owner'] is defined and not hasentry ? b.owner : hasentry %}
    {% endfor %}

    {## Create a set of common settings shared by each block, but allow for
        them to be overridden by settings passed into the builder macros ##}
    {% set common = {
        container: 'default',
        builder  : builder,
        section  : hasentry.owner.section.handle ?? null,
        entryid  : hasentry.owner.id ?? null,
        entryurl : hasentry.owner.url ?? null,
        entrytype: hasentry.owner.type.handle ?? null,
    } | merge( settings ) %}

    {% set blockpath = settings.blockpath ??? [
        "_site/block.%blocktype%.%variant%",
        "_site/block.%blocktype%",
        "_core/block.%blocktype%",
        "_site/block",
        "_core/block"
    ] %}

    {% for block in BuilderBase( blocks, common ) %}
        {% set path = blockpath | map( p => p|replace({
            '%layout%'   : block.settings.layout    ??? null,
            '%section%'  : block.settings.section   ??? null,
            '%builder%'  : block.settings.builder   ??? null,
            '%blocktype%': block.settings.blocktype ??? null,
            '%entrytype%': block.settings.entrytype ??? null,
            '%variant%'  : block.settings.variant   ??? null,
        }) ) %}

        {{ include( path, { block: block, loop: loop }, withContext = false ) }}
    {% endfor %}
{% endmacro %}