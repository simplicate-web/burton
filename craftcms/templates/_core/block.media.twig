{## Media Block   [Core Template]
{---------------------------------------------------------------------------------------}
 -> http://localhost:8000/sitehub/blocks/media
{-------------------------------------------------------------------------------------##}
{% extends [ "_site/block", "_core/block" ] %}


{## Zone 2 Content / Variant Routing
{-------------------------------------------------------------------------------------##}
{% block block__zone2 %}
    {%- set settings = block.settings ??? null -%}
    {%- set settings = settings is not null and settings is iterable ? settings : {} -%}

    {%- set source  = block.source.value  ??? 'media'   -%}
    {%- set variant = block.variant.value ??? 'default' -%}

    {%- set mediaitems = source == 'media'
        ? block.media.all() ??? block.media ??? []
        : null -%}

    {%- if source == 'media' -%}
        {%- set mediaitems = block.media.all() ??? block.media ??? [] -%}
    {%- endif -%}

    {%- if source == 'external' -%}
        {% for item in block.external.all() ??? block.external ??? [] %}
            {% set url = item.sourceUrl ??? item.url ??? null %}
            {% if url %}
                {% set oembed = MediaBase( url ) %}
                {% set mediaitems = mediaitems|merge([{
                    _media   : item,
                    url      : url,
                    kind     : 'external',
                    oembed   : oembed,
                    images   : item.images.one() ? item.images.all() : [],
                    summary  : item.summary  ??? oembed.summary ??? null,
                    headline : item.headline ??? oembed.title   ??? null,
                }]) %}
            {% endif %}
        {% endfor %}
    {%- endif -%}

    {% if source == 'collect' %}
        {% set params = {
            limit: block.source.settings.limit ??? -1,
            field: 'media'
        } %}

        {% set mediaitems = CollectionBase( block.collections, params ) %}
    {% endif %}

    {% if settings.variant ??? 'default' == 'code' %}

    {% endif %}

    {## Let's us inherit from this template **at this point** in the render process,
        without requiring that we duplicate the above "collection" logic ##}
    {%- set blockname = 'media__' ~ settings.variant ??? 'default' -%}
    {{- block( blockname ) is defined ? block( blockname ) : block( 'media__default' ) -}}
{% endblock %}



{## Media Default
{-------------------------------------------------------------------------------------##}
{% block media__default %}
    {%- set settings = settings ?? block.settings ?? null -%}
    {%- set settings = settings is not null and settings is iterable ? settings : {} -%}
    {%- set settings = { mediadeck: 'default' } | merge( settings ) -%}
    {%- import "_assemble" as assemble -%}
    {{- assemble.media( settings.mediadeck, mediaitems, settings ) -}}
{% endblock %}



{## Media Third Party Embed
{-------------------------------------------------------------------------------------##}
{% block media__code %}
    {%- set settings = settings ?? block.settings ?? null -%}
    {%- set settings = settings is not null and settings is iterable ? settings : {} -%}
    {%- set settings = { mediadeck: 'default' } | merge( settings ) -%}

    {# {% import "_assemble" as assemble %}
    {{ assemble.iframe( block.code|default(), block.settings ) }} #}
{% endblock %}