{## Media Block Base
{-------------------------------------------------------------------------------------##
    -> http://localhost:8000/sitehub/blocks/media
{-------------------------------------------------------------------------------------##}
{% extends [ "_site/block", "_core/block" ] %}


{## Media Block Content ##}
{% block content block('block__assemble') %}

{% block block__assemble %}
    {% set settings    = settings ??? block.settings ??? {}  %}
    {% set microlayout = settings.microlayout ??? 'zone1Top' %}

    {% import "_assemble" as assemble %}
    {{ assemble.microlayout( microlayout, {
        zone1 : block('block__text'),
        zone2 : block('block__media'),
        header: block('block__header'),
        footer: block('block__footer'),
    }, settings ) }}
{% endblock %}


{## Zone 2 Content ##}
{% block block__media %}
    {% set settings    = settings ??? block.settings ??? {}  %}
    {% set mediasource = block.source.value   ??? 'assets'   %}
    {% set mediaitems  = [] %}

    {% if mediasource == 'assets' %}
        {% set mediaitems = block.assets.all() ??? block.assets ??? [] %}
    {% endif %}

    {% if mediasource == 'external' %}
        {% for item in block.external.all() ??? block.external ??? [] %}
            {% set url = item.sourceUrl ??? item.url ??? null %}
            {% if url %}
                {% set oembed = MediaBase( url ) %}
                {% set mediaitems = mediaitems|merge([{
                    _media   : item,
                    url      : url,
                    kind     : 'external',
                    oembed   : oembed,
                    images   : item.images.one() ? item.images.all() : [],
                    summary  : item.summary  ??? oembed.summary ??? null,
                    headline : item.headline ??? oembed.title   ??? null,
                }]) %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if mediasource == 'code' %}
        {% set mediaitems = block.images.all() ??? block.images ??? [] %}
    {% endif %}

    {% if mediasource == 'collect' %}
        {% set params = {
            limit: block.source.settings.limit ??? -1,
            field: 'assets'
        } %}

        {% set mediaitems = CollectionBase( block.collections.ids(), params ) %}
    {% endif %}

    {% import "_assemble" as assemble %}
    {% set mediacollection = settings.mediacollection ??? 'default' %}

    {{ assemble.media( mediaitems, mediacollection, settings ) }}
{% endblock %}
