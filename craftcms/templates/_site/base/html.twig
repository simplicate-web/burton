{% extends craft.app.request.isAjax() and not craft.app.request.getIsPreview()
    ? template_from_string("{% block html %}{% block page__ajax '' %}{% endblock %}")
    : "_core/html" %}

{% import '_site/base/html.javascript' as js %}

{% block head__top %}
    {{ js.prefetch([
        'https://unpkg.com',
        'https://cdn.polyfill.io',
        'https://cdn.jsdelivr.net',
        'https://fonts.googleapis.com',
        'https://fonts.gstatic.com',
    ]) }}
    {{ parent() }}
{% endblock %}

{% block head__fonts   include( '_site/base/html.fonts'  ) %}
{% block head__styles  include( '_site/base/html.styles' ) %}
{% block head__scripts js.scripts() %}

{% block html %}

    {## for product/event entries, duplicate the object into the eponymous `entry` var ##}
    {% set entry = entry ??? product ??? event ??? null %}

    {% set _eager = {
        common:
            ["images", "topics"],

        header:
            ["headerBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular"
            ] | map( p => "headerBuilder.#{p}") ),

        content:
            ["contentBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular","highlight:taxonomies",
                "collection:items","collection:entries","collection:assets","collection:taxonomies",
            ] | map( p => "contentBuilder.#{p}") ),

        sidebar:
            ["sidebarBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular","highlight:taxonomies",
                "collection:items","collection:entries","collection:assets","collection:taxonomies",
            ] | map( p => "sidebarBuilder.#{p}") ),
    } %}

    {% if entry and entry.id|default() and className(entry) %}
        {% do craft.app.elements.eagerLoadElements(
            className(entry),
            [entry],
            [''] | merge(_eager.common  ??? '')
                 | merge(_eager.header  ??? '')
                 | merge(_eager.content ??? '')
                 | merge(_eager.sidebar ??? '')
        ) %}
    {% endif %}

    {## supes dupes important. don't remove. ##}
    {## https://stackoverflow.com/a/32642249 ##}
    {{ parent() }}
{% endblock %}
