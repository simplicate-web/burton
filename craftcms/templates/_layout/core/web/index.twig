{% extends craft.app.request.isAjax() and not craft.app.request.getIsPreview()
    ? '_layout/core/web/ajax'
    : '_layout/core/web/full' %}


{% block html %}

    {% set entry = entry ??? product ??? event ??? null %}

    {## handle redirects for entries of that type ##}
    {% if ( 'redirect' == entry.type.handle ??? null ) and ( entry.redirect.url ??? null ) %}
        {% redirect entry.redirect.url %}
    {% endif %}

    {% set prefetchUrls = [
        'https://unpkg.com',
        'https://cdn.polyfill.io'
    ] %}

    {% set baseUrl = getenv('CRAFT_WEB_URL') ~ '/' %}

    {% set _eager = {
        common:
            ["images", "topics"],

        header:
            ["headerBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular"
            ] | map( p => "headerBuilder.#{p}") ),

        content:
            ["contentBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular","highlight:taxonomies",
                "collection:items","collection:entries","collection:assets","collection:taxonomies",
            ] | map( p => "contentBuilder.#{p}") ),

        sidebar:
            ["sidebarBuilder"] |
            merge([
                "image:images","media:localAssets","fragment:modular","highlight:taxonomies",
                "collection:items","collection:entries","collection:assets","collection:taxonomies",
            ] | map( p => "sidebarBuilder.#{p}") ),
    } %}

    {% if entry and entry.id|default() and className(entry) %}
        {% do craft.app.elements.eagerLoadElements(
            className(entry),
            [entry],
            [''] | merge(_eager.common  ??? '')
                 | merge(_eager.header  ??? '')
                 | merge(_eager.content ??? '')
                 | merge(_eager.sidebar ??? '')
        ) %}
    {% endif %}

    {## supes dupes important. don't remove. ##}
    {## https://stackoverflow.com/a/32642249 ##}
    {{ parent() }}
{% endblock %}
