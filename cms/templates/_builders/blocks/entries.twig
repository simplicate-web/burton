{% extends blockConfig.layout %}
{% use "_builders/blocks/_default" %}

{% set items         = items ??? [] %}
{% set itemComponent = itemsConfig.component ??? null %}
{% set method        = content.method       ??? 'choose' %}

{% set hasSearch     = ( method == 'allSearch' ) %}
{% set hasPaginate   = ( method == 'allSearch' ) %}

{% set overrideCard  = content.card.reference() ??? null %}
{% set cardLayout    = overrideCard.useCard ??? itemsConfig.useCard ??? '' %}
{% set content1Hide  = not text|trim and not hasSearch %}
{% set entryUrl      = entry.url ??? '' %}
{% set topics        = [] %}

{% if method != 'choose' %}
    {% set contentType   = content.contentType  ??? '' %}
    {% set order         = content.order        ??? 'mostRecent' %}
    {% set limit         = content.limit        ??? 3 %}
    {% set perPage       = content.perPage      ??? 25 %}
    {% set topics        = content.topics.all() ??? [] %}

    {% set orderBy = 'postDate DESC' %}
    {% set orderBy = ( order == 'random'       ) ? 'RAND()'     : orderBy %}
    {% set orderBy = ( order == 'alphabetical' ) ? 'title DESC' : orderBy %}

    {% set queryString = craft.app.request.getParam('q') ??? null %}
    {% set queryLimit  = ( method == 'limitedSearch' ) ? limit : perPage %}

    {% if contentType %}
        {% set section = contentType.value %}
        {% set query   = craft.entries().section(section) %}

        {# are we doing a text based search? #}
        {% if hasSearch and queryString %}
            {% set query   = query.search(queryString) %}
            {% set orderBy = 'score' %}
        {% endif %}

        {# are we doing a topic based search? #}
        {% if topics %}
            {% set query = query.relatedTo(topics) %}
        {% endif %}

        {% set query = query
            .orderBy(orderBy)
            .limit(queryLimit)
        %}

        {% if method == 'allSearch' %}
            {% paginate query as pageInfo, pageEntries %}
            {% set items = pageEntries %}
        {% else %}
            {% set items = query.all() %}
        {% endif %}
    {% endif %}
{% endif %}

{% block content1 -%}
    {{- text -}}

    {%- if hasSearch -%}
        <div class="flex flex-col md:flex-row items-center gap-2 lg:gap-5 p-3 lg:p-8 bg-gray-200 mb-6">
            <div class="grow w-full">
                <p class="like-h4 text-gray-400 !mb-0 !font-body">Showing {{pageInfo.first}}-{{pageInfo.last}} of {{pageInfo.total}} total results</p>
            </div>

            <div class="w-full">
                {{ include( '_components/search/form', {
                    headline: '',
                    url: entryUrl
                }, withContext = false ) }}
            </div>
        </div>
    {%- endif -%}
{%- endblock %}

{% block content2 %}

    {% if itemComponent %}
        {{ include( itemComponent ) }}
    {% else %}
        {% for item in items %}
            {{ include(
                [
                    '_sections/' ~ item.section.handle ~ '/_tease.' ~ builder,
                    '_sections/' ~ item.section.handle ~ '/_tease',
                    '_sections/_tease.' ~ builder,
                    '_sections/_tease'
                ],{
                    entry: item,
                    card: cardLayout,
                    topics: topics,
                }, withContext = false
            ) }}
        {% endfor %}
    {% endif %}
{% endblock %}

{% block footer -%}
    {% if hasPaginate %}
        {{ include( '_components/pagination/pagination' ) }}
    {% endif %}
{%- endblock %}